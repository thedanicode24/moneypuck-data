---
title: "Exploring data"
format: html
editor: visual
---

## Loading packages

```{r}
library(tidyverse)
library(reshape2)
library(sqldf)
library(patchwork)
```

## Importing data

```{r}
url = "https://moneypuck.com/moneypuck/playerData/careers/gameByGame/regular/skaters/8479318.csv"
df <- read.csv(url)
```

## Wrangling data

### 1. Removing variables

```{r}

```

### 2. Removing observations

```{r}
any(is.na(df))
```

### 3. Viewing data

```{r}
# head(df)
```

### 4. Converting variables types

```{r}
df$season <- as.factor(df$season)
df$opposingTeam <- as.factor(df$opposingTeam)
df$home_or_away <- as.factor(df$home_or_away)
df$situation <- as.factor(df$situation)
```

### 5. Creating derived variables

```{r}
```

## Variable breakdown

```{r}
```

## Exploratory data analysis

### 1. Basic statistics

```{r}
sd(df$I_F_goals)
sd(df$I_F_points)
sd(df$icetime)
sd(df$gameScore)
```

### 2. Returning data

```{r}
sqldf("SELECT min(gameScore), gameDate, opposingTeam FROM df_selected")
sqldf("SELECT max(gameScore), gameDate, opposingTeam FROM df_selected")
sqldf("SELECT max(I_F_goals), gameDate, opposingTeam FROM df_selected")
sqldf("SELECT max(I_F_points), gameDate, opposingTeam FROM df_selected")
```

### 3. Computing and visualizing frequency distributions

```{r}
situations <- unique(df$situation)

for (s in situations) {
  subset_df = subset(df, situation==s)
  p_score <- ggplot(subset_df, aes(x=gameScore)) +
    geom_histogram(fill="royalblue3", color="black", bins=20) +
    labs(title = "Game Score - Distribution by Situation",
         subtitle=paste("Situation:", s),
         x = "Game Score",
         y="Number of games") +
    theme(plot.title = element_text(face="bold"))
  print(p_score)
}
```

```{r}
bp_score <- ggplot(df, aes(x = situation, y = gameScore)) +
  geom_boxplot(fill="red3", color="red1") +
  labs(title = "Game Score Distribution by Situation",
       subtitle=paste("Situation:", s),
       x = "Situation",
       y = "Game Score") +
  theme(plot.title = element_text(face="bold")) + 
  stat_summary(fun=mean, geom="point", shape=20, 
               size=5, color="white", fill="white")
print(bp_score)
```

```{r}
situations <- unique(df$situation)

for (s in situations) {
  subset_df = subset(df, situation==s)
  bp_score <- ggplot(subset_df, aes(x=season, y=gameScore)) +
    geom_boxplot(fill="dodgerblue4", color="dodgerblue") +
    labs(title = "Game Score - Distribution by Situation",
       subtitle=paste("Situation:", s),
       x = "Situation",
       y = "Game Score") +
    theme(plot.title = element_text(face="bold")) + 
    stat_summary(fun=mean, geom="point", shape=20, 
                 size=5, color="white", fill="white")
  print(bp_score)
}
```

```{r}
situations <- unique(df$situation)

for (s in situations) {
  subset_df = subset(df, situation==s)
  subset_df %>%
  summarize(Situation = s,
    MIN = min(gameScore),
    LQ = quantile(gameScore, .25),
    UQ = quantile(gameScore, .75),
    AVG = mean(gameScore),
    M = median(gameScore),
    MAX = max(gameScore)) -> tibble
  print(tibble)
}
```

```{r}
situations <- unique(df$situation)

for (s in situations) {
  subset_df = subset(df, situation==s)
  bp_score <- ggplot(subset_df, aes(x=opposingTeam, y=gameScore)) +
    geom_boxplot(fill="blue4", color="dodgerblue") +
    labs(title = "Game Score - Distribution by Opposing Team in each Situation",
       subtitle=paste("Situation:", s),
       x = "Situation",
       y = "Game Score") +
    theme(plot.title = element_text(face="bold")) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    stat_summary(fun=mean, geom="point", shape=10, 
                 size=5, color="white", fill="white")
  print(bp_score)
}
```

### 4. Computing and visualizing correlations

```{r}

```

### 5. Computing and visualizing means and medians

```{r}
df %>%
  group_by(situation, home_or_away) %>%
  summarize(meanGS = mean(gameScore), medianGS = median(gameScore)) -> tibble
new_labels <- c("0"="HOME", "1"="AWAY")

avg_score <- ggplot(tibble, aes(x=situation, y=meanGS)) +
  geom_bar(stat="identity", width=.5, fill="slateblue4") +
  labs(title="Average Game Score (Home/Away)", 
       x = "Home/Away",
       y = "Average Game Score") +
  geom_text(aes(label=round(meanGS,2)), vjust=-0.3, position=position_dodge(0.5), size=3) +
  ylim(-1,3) +
  theme(plot.title = element_text(face="bold")) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  facet_wrap(~home_or_away, labeller=labeller(new_labels), ncol=1)
  
median_score <- ggplot(tibble, aes(x=situation, y=medianGS)) +
  geom_bar(stat="identity", width=.5, fill="sienna1") +
  labs(title="Median Game Score (Home/Away)", 
       x = "Home/Away",
       y = "Median Game Score") +
  geom_text(aes(label=round(medianGS,2)), vjust=-0.3, position=position_dodge(0.5), size=3) +
  ylim(-1,3) +
  theme(plot.title = element_text(face="bold")) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  facet_wrap(~home_or_away, labeller=labeller(new_labels), ncol=1)
  
print(avg_score + median_score + plot_layout(ncol=2))
```

```{r}
df %>%
  group_by(situation, home_or_away) %>%
  summarize(meanG = mean(I_F_goals)) -> tibble_goals
new_labels <- c("0"="HOME", "1"="AWAY")

avg_goals <- ggplot(tibble_goals, aes(x=situation, y=meanG)) +
  geom_bar(stat="identity", width=.5, fill="skyblue4") +
  labs(title="Average Goals (Home/Away)", 
       x = "Situation",
       y = "Average Goals") +
  geom_text(aes(label=round(meanG,2)), vjust=-0.3, position=position_dodge(0.5), size=3) +
  ylim(0,1.5) +
  theme(plot.title = element_text(face="bold")) +
  theme(axis.text.x=element_text(angle=45, hjust=1)) +
  facet_wrap(~home_or_away, labeller=labeller(new_labels))

print(avg_goals)
```
